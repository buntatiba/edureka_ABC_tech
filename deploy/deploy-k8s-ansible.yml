- hosts: "{{ env }}"
  become: yes
  tasks: 
    - name: Deploying Application pods...
      shell: | 
         if [ `kubectl get deployment | grep -v NAME | awk '{print $1}' | grep abctechnologies-1-0 | wc -l` -gt 0 ]; then  
            echo "deleteing previous application deployment"
            kubectl delete deployment `kubectl get deployment | grep -v NAME | awk '{print $1}' | grep abctechnologies-1-0`
            echo "creating new application deployment"
            kubectl create deployment abctechnologies-1-0 --image=buntatiba/abctechnologies:{{ build }}
         else 
            echo "Deploying abctechnologies-1-0 Application"
            kubectl create deployment abctechnologies-1-0 --image=buntatiba/abctechnologies:{{ build }}
         fi
    - name: deploying service
      shell: |
         if [ `kubectl get svc | grep abctechnologies-1-0  | awk '{print $1}' | wc -l` -gt 0 ]; then
            echo "app service found, No actions taken"
            #kubectl delete svc `kubectl get svc | grep abctechnologies-1-0 | awk '{print $1}'`
         else
            echo "Creating App Services"
            kubectl expose deployment abctechnologies-1-0 --name abctechnologies-1-0 --type NodePort --port 80 --target-port 8080
         fi
    - name: increase replicas 
      shell: kubectl scale deploy abctechnologies-1-0 --replicas=2
    
    - name: Update Deployment YAML
      ansible.builtin.replace:
        path: /path/to/deployment.yaml
        regexp: '(^(\s+)containers:(\s+))'
        replace: |
          \1containers:\n\2- name: abctechnologies\n\2  image: buntatiba/abctechnologies:11\n\2  ports:\n\2  - containerPort: 8181\n\2
      become: false

    - name: Create Service YAML
      ansible.builtin.template:
        src: templates/service.yaml.j2
        dest: /path/to/service.yaml
      become: false

    - name: Apply Deployment and Service
      ansible.builtin.shell: "kubectl apply -f /path/to/deployment.yaml -f /path/to/service.yaml"
      become: false

       #- name: deploy app
      #shell: kubectl create deployment abctechnologies-1-0 --image=buntatiba/abctechnologies:{{ build }}
    #- name: deploy service
      #shell: kubectl expose deployment abctechnologies-1-0 --name abctechnologies-1-0 --type NodePort --port 80 --target-port 8181